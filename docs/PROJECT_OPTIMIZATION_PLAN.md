# 项目优化计划（Text2Image_audio）

## 目标与约束
- 目标：提升安全性、稳定性、一致性、可读性与可维护性，并增强 AI 可读性/可排障性。
- 约束：零功能回归、零视觉变化、零接口契约破坏；小步提交、可回滚、每步回归验证。

## 风险分级
- 低风险（立即执行）：文档、.gitignore、删除危险日志、修复明显返回值/重复路由/重复编码问题。
- 中风险（需回归）：安全响应头与 CORS 补充、错误码与响应格式标准化（不影响前端逻辑前提下）。
- 高风险（需灰度/开关）：OAuth 配置收敛与动态回调、legacy JWT 清理、轮询频率优化、路由与控制器重构。

## 分阶段计划
### Phase 0：项目卫生（不影响功能/显示）
1) 文档与指引：落盘本计划、完善部署/ENV 清单与回滚入口。
2) 版本控制与密钥防泄漏：新增 .gitignore（忽略 api.env、*.env、*.log、logs/ 等）；要求轮换已暴露密钥。
3) 危险日志检查：删除前端 token 调试输出与冗余 console 噪音。

验收：启动/构建与 UI 行为均不变。

### Phase 1：后端稳定性修复（零视觉）
1) 下载接口：/api/images/download/* 修复返回 undefined（先加头再返回 Response 对象）。
2) 路由去重：去除重复的 GET /api/images/stats 分支（保留可达分支）。
3) Pollinations：移除负面词参数的二次编码，仅用 URLSearchParams 处理。
4) 日志规范：脱敏 Authorization/Cookie；统一日志等级与格式。

验收：接口契约与页面行为均不变；下载稳定。

### Phase 2：一致性与安全头（小步）
1) 响应头：在不改变 CORS 策略的前提下，补充 Vary: Origin、X-Content-Type-Options: nosniff、Referrer-Policy、Permissions-Policy 等安全头。
2) 状态码与 JSON：失败返回 4xx/5xx，保持前端预期字段，统一 Result 结构。

验收：前端正常，网络面板无新增告警。

### Phase 3：OAuth/JWT 一致性（灰度）
1) 统一 ENV：GOOGLE_CLIENT_ID/GOOGLE_CLIENT_SECRET，旧变量仅作兼容并打印告警。
2) 动态回调：redirect_uri 基于 ENV/部署域动态化，移除硬编码。
3) legacy JWT：给出轮转期（开关+观测），到期移除旧制式。

验收：生产/本地 Google 登录均正常，无 redirect_uri_mismatch。

### Phase 4：前端可维护性与 AI 友好
1) 契约清理：删除未实现/未使用的 API 客户端方法或标注 @deprecated。
2) 初始化收敛：减少全局 window.*；集中入口初始化与订阅，避免重复监听。
3) 结构拆分：把超长文件（voice_app/ui_handler）拆为 API/状态/视图/可视化/历史模块；CSS 按页面/组件拆分并引入 CSS 变量（颜色/间距）。

验收：构建后 UI 与交互与当前一致。

### Phase 5：性能与运维（可选）
1) 轮询策略：将每秒 /api/images/stats 改为本地倒计时 + 低频服务端刷新（灰度开关）。
2) 重试策略：对 429/5xx 分类与上限，必要时熔断与告警。
3) 监控指标：DeepSeek/Pollinations 失败率、P95/P99、下载成功率。

验收：无用户可感知变化，指标可见。

## 任务清单（执行顺序）
- [ ] P0-1 新增 .gitignore 忽略敏感文件；发布密钥轮换提示
- [ ] P0-2 删除前端 token 调试日志与冗余 console 噪音
- [ ] P1-1 修复下载接口返回 undefined 的问题
- [ ] P1-2 去重 GET /api/images/stats 路由分支
- [ ] P1-3 修复 Pollinations 负面词二次编码
- [ ] P1-4 统一日志脱敏与格式
- [ ] P2-1 补充安全头（不改变现有 CORS 行为）
- [ ] P2-2 统一错误状态码与响应 JSON 结构（不影响前端依赖字段）
- [ ] P3-1 统一 Google OAuth ENV（向后兼容告警）
- [ ] P3-2 动态 redirect_uri（环境自适应）
- [ ] P3-3 legacy JWT 轮转与移除（开关+观测）
- [ ] P4-1 清理未使用/未实现客户端方法或加 @deprecated
- [ ] P4-2 收敛初始化与事件订阅，减少全局变量
- [ ] P4-3 拆分大文件与样式模块（仅结构）
- [ ] P5-1 轮询频率灰度优化
- [ ] P5-2 重试策略分类与上限
- [ ] P5-3 监控与告警埋点

## 回归清单
- 功能：
  - 图片：优化→生成→多图显示→下载→自动保存（登录态）→列表/统计→删除
  - 语音：生成→播放→下载→复制分享→历史
  - 认证：注册/登录/校验→Google 登录→Cookie/LocalStorage 行为
  - 工具：翻译、负面词翻译、反馈提交/列表
- UI：核对首页/图片页/语音页/个人中心关键元素与文案无变化。
- 端到端：本地 wrangler dev 与生产域对照；网络面板无新增 4xx/5xx/安全告警。

## 回滚策略
- 每步独立提交，可单独回滚；高风险改动使用开关/灰度，异常时立即关闭或回滚。

> 下一步：先执行 Phase 0（文档与 .gitignore 与日志清理），随后进行 Phase 1 的三项无风险修复，步步回归验证，确保零功能/零视觉回归。
