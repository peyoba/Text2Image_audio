name = "text2image-api" # 您可以自定义Worker的名称
main = "backend/index.js" # 指向新的JS Worker入口文件
compatibility_date = "2024-03-01" # 使用一个较新的兼容日期
compatibility_flags = ["nodejs_compat"] # 启用Node.js兼容性，支持crypto模块

# Python Workers特定配置
# [build]
# command = "pip install -r backend/requirements.txt -t backend/.wrangler/dist/deps" # 安装依赖到指定目录

# [[python_workers]]
# modules = [
#   { name = "main", path = "backend/worker.py" } # 仅保留主模块
#   # { name = "pollinations_api_handler", path = "backend/pollinations_api_handler.py" }, # 已整合
#   # { name = "config_module", path = "backend/config.py" } # 已整合或通过env获取
#   # 我们将首先尝试将 optimize_api 和 generation_api 的逻辑直接迁移到 worker.py
#   # 如果有必要，后续再将它们拆分为可导入的模块
#   # { name = "optimize_api_logic", path = "backend/api/optimize_api.py" },
#   # { name = "generation_api_logic", path = "backend/api/generation_api.py" }
# ]

# 环境变量 (稍后在Cloudflare仪表盘中设置更安全)
# [vars]
# # POLLINATIONS_API_KEY = "your_pollinations_key_here" # 部署时在Cloudflare后台设置
# # DEEPSEEK_API_KEY = "your_deepseek_key_here"       # 部署时在Cloudflare后台设置
# # OPENAI_API_KEY = "your_openai_key_here" # 如果您的config.py中引用了

# KV Namespace 绑定 (用于存储任务状态等)
# [[kv_namespaces]]
# binding = "TASK_STORE"
# id = "your_kv_namespace_id_here" # 部署后在Cloudflare后台创建并替换

# R2 Bucket 绑定 (用于存储生成的图片/音频等)
# [[r2_buckets]]
# binding = "ASSETS_BUCKET" # 在worker.py中通过 env.ASSETS_BUCKET 访问
# bucket_name = "text2image-assets"

# 如果您的Python Worker需要访问外部网络，需要配置
# [experimental]
# # fetch_module_config = true # 较旧的配置方式，可能不需要了

# 如果您的应用需要访问外部网络，例如调用Pollinations或DeepSeek API
[placement]
mode = "smart" 

[vars]
# API配置 - 2026-01 更新：使用新的 gen.pollinations.ai API
# 旧 API (image.pollinations.ai) 已弃用，需要迁移到新系统
POLLINATIONS_GEN_API_BASE = "https://gen.pollinations.ai"
POLLINATIONS_IMAGE_API_BASE = "https://gen.pollinations.ai"
POLLINATIONS_TEXT_API_BASE = "https://text.pollinations.ai"

# ⚠️ 重要：新 API 需要认证！请在 Cloudflare Workers 控制台设置以下环境变量：
# POLLINATIONS_API_TOKEN = "sk_xxxxxxxx" (从 https://enter.pollinations.ai 获取)
# 
# 获取 API Key 步骤：
# 1. 访问 https://enter.pollinations.ai
# 2. 使用 GitHub 登录
# 3. 购买 Pollen 积分 (或等待每日免费额度)
# 4. 生成 API Key (sk_ 开头的密钥)
# 5. 在 Cloudflare Workers 控制台添加环境变量 POLLINATIONS_API_TOKEN
DEEPSEEK_API_URL = "https://api.siliconflow.cn/v1/chat/completions"
DEEPSEEK_MODEL = "deepseek-ai/DeepSeek-V2.5"

# 音频配置
DEFAULT_AUDIO_MODEL = "openai-audio"
DEFAULT_AUDIO_VOICE = "nova"

# 认证配置 - 已迁移到 Cloudflare 环境变量
# JWT_SECRET - 在 Cloudflare Workers 控制台中设置
# ADMIN_KEY - 在 Cloudflare Workers 控制台中设置

# 日志配置
LOG_LEVEL = "error"  # 生产环境使用 error 级别

# KV Namespace 绑定 (用于存储用户数据)
[[kv_namespaces]]
binding = "USERS"
id = "1c05d537e46f401689e85a655dbf692e"

# KV Namespace 绑定 (用于存储图片缓存)
[[kv_namespaces]]
binding = "IMAGES_CACHE"
id = "3d9618b06326448888cbbf45f53acce4"

# KV Namespace 绑定 (用于存储重置密码token)
[[kv_namespaces]]
binding = "RESET_TOKENS"
id = "18ab969ea8594e729c412d4c8e5d6afd"

# KV Namespace 绑定 (用于存储用户反馈)
[[kv_namespaces]]
binding = "FEEDBACK"
id = "937caf6061f04708929c2c4084b5c075" 